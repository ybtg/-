# 四旋翼飞控入门
## 飞控的大致介绍
1. 实验室目前使用的固定翼飞控主要有RadioLink（乐迪）的PixHawk，MiniPix，CUAV（雷迅）的V6X，X7等等。以上飞控我都使用过，这些飞控存在一定的硬件差距，但是地面站（Mission Planner）操作基本都类似。
2. 我们目前主要学习地面站调参，飞控与飞机的接线，自稳逻辑调整，飞行航线规划等任务。
3. 以后各位有能力的同学可以试着研究研究MavROS，通过ROS中的MavROS库，实现上位机与飞控的通信，通过使用MavROS控制飞控，就能完成相当多复杂的任务！
## 地面站简介
1. [Mission Planner](https://ardupilot.org/planner/docs/mission-planner-overview.html)是[ArduPilot](https://ardupilot.org/)开源自动驾驶仪项目的全功能地面站应用程序。这个是[Ardupilot的开源库](https://github.com/ArduPilot/ardupilot)。

    ![1.jpg](https://s2.loli.net/2024/08/05/XMJ2AKTamphjtw1.jpg)
    ![2.jpg](https://s2.loli.net/2024/08/05/QJLSeGX8lOWBufF.jpg)
2. Mission Planner是飞机、直升机和遥控车的地面控制站。它仅与 Windows兼容。Mission Planner可用作自动控制的配置实用程序或动态控制补充。你可以使用 Mission Planner 执行以下操作：
   * 将固件加载到自动驾驶仪中。
   * 设置、配置和调整您的飞机以获得最佳性能。
   * 通过在 Google 或其他地图上进行简单的点击式路径点输入，即可规划、保存自主任务并将其加载到自动驾驶仪中。
   * 下载并分析自动驾驶仪创建的任务日志。
   * 与 PC 飞行模拟器连接，创建完整的硬件在环无人机模拟器。
   * 在运行时监控飞机的状态。
   * 记录遥测日志，其中包含有关机载自动驾驶仪日志的更多信息。
   * 查看并分析遥测日志。
## 拿到飞控应该做的事情
1. 首先需要确保你的电脑能够连上飞控，插上识别不到可能是数据线的问题，也有可能是飞控的问题，识别不到就换数据线或者飞控试试。识别到但是无法正常识别可能是驱动的问题，RadioLink提供了一个[驱动补丁](http://www.radiolink.com.cn/firmware/wiki/DriverfixTool.zip)。如果还是不行，去淘宝客服那里问问。
2. 安装固件。固件可以在Ardupilot的网站里找到，也可以去厂商的网站里找。固件的版本不是越新越好，当飞控出现玄学bug的时候，重刷不同版本固件可能会解决问题，这里附上[固件下载地址](https://firmware.ardupilot.org/Plane/)(如果找不到对应飞控的固件，请去厂商官网或者咨询淘宝客服)。
3. 校准加速度计，罗盘，遥控器。校准过程MP中会有提示，这里不再赘述。
4. 调参。在配置调试->全部参数表里，右侧有一个搜索框， 基本调参有这些：
   * 映射遥控器通道：
        + FLTMODE_CH 7 (遥控器CH7配置为切换飞行模式拨杆) RC5_OPTION 153 ArmDisam 4.2.0或更高(41 ArmDisam 4.1.9或更低)(遥控器CH5配置为解锁飞控)(有一些固件没有这个参数设置，比如MiniPix是通过遥控器摇杆内八来解锁的)
   * 配置飞行模式（初始设置->飞行模式）：
        + 手动模式：飞控不对遥控器传来的信号做任何处理，直接输出到servo口。 
        + 自稳模式：主要有FBWA和FBWB两种，一般用FBWB比较好，具体差别可以看这里。飞控根据当前的飞行姿态对输入的rc信号进行限制，同时控制各servo输出使飞机尽量保持平稳的飞行姿态。飞控默认的PID参数适合绝大部分飞行，但并不是最好的，需要自己进行微调。 
        + 自动模式：飞控按照写入的航线飞行，飞行姿态的控制与自稳模式相同。
   * 禁用这些参数：
        + ARMING_CHECKING (起飞前检查) BRD_SAFETYENABLE (安全开关) 禁用这些选项的原因是飞控上电会进行自检，如果没有检测到GPS信号或者姿态异常就不会让你启动，在室内调试很不方便，同时请记住：__室内调试禁止上浆！__
## 飞控与飞机的接线
1. 连接分电板与电调：
   * 常见的分电板差不多是如下两种
   ![5.png](https://s2.loli.net/2024/08/05/wPgmGtNjVnZKTEU.png)
   ![6.jpg](https://s2.loli.net/2024/08/05/OIxcBz5vWfSLedJ.jpg)
   * 将电调的正负焊接到分电板的输出口上面的正负，再将一根XT60的线或者T插头的线焊接到分电板的输入口
2. 连接电机与电调：
   * 我们所使用的电机都是无刷电机，所以需要用电调来控制电机的旋转，先将三根线任意接上，四个电机电调都接好。
   * 再把电调上面的PWM的输入线连接到飞控上，注意正负，一般中间的线是正极，但有些电调没有中间的线，就不用管，黑线一般是GND，白线一般是信号线，黑线对着“-”，白线对着“S”，从M1开始接，M1到M4对应1号电机到4号电机。
   ![4.png](https://s2.loli.net/2024/08/05/XfZaroFmdQCPG58.png)
   * 在Mission Planner的电机测试中，测试四个电机的转向。
    ![7.png](https://s2.loli.net/2024/08/05/G1LbNShDdYmlMsW.png)
   * 正确的转向如下图所示，如果方向相反，调换三根线中的任意两根线即可。
    ![8.png](https://s2.loli.net/2024/08/05/Q4xKkChncDF3ayz.png)
3. power接口，电流计共三根线，一端接电池，另一端接分电板，分出来一根较细的线就是飞控的power线。
4. RCIN/RSSI接口，是用来插接收机的，上电之后把遥控器调到对码模式再长按接收机上的小按钮，对上码之后遥控器就可以操控飞机了。
5. GPS接口，没什么好说的，直接插就可以了。
6. 数传接口，在MiniPix上是TELEM1，在别的飞控上面记不清了，可以对照说明书看，说明书上很详细。
## 调试环节
1. 拿到室外准备起飞的时候，一定要在各个硬件工作正常的情况下起飞，要注意的有GPS搜星是否正常（不正常会漂移），罗盘校准是否正常（不正常地面站上机头的朝向会特别奇怪），电池电压是否足够，航点是否已经写入等等。
2. 挂载有sd卡的飞控会在飞行时自动记录飞行数据，如果飞行时意外炸机，可以看看日志当时发生了什么。（数据闪存日志->通过Mavlink下载日志） 
   ![3.jpg](https://s2.loli.net/2024/08/05/AJpduNghFHrjk19.jpg)
## 最后
调飞控会遇到非常非常多玄学bug，以至于我现在都还不明白这些bug是怎么发生的，我干了什么他就正常了（或者说怎么做都没用）。如果你也碰到了，欢迎来问我，我或许可以经验主义的跟你说道说道，但更建议你先去google，去查一查官方文档，看中文文档和说明书。这里附上[Ardupilot官方文档](https://ardupilot.org/plane/index.html)，[CUAV文档](https://doc.cuav.net/zh-hans/)。
## 建议
看参数表的时候建议中英一起看，中文版机翻味有点重，可能会曲解原文意思，英文就是全部参数表Description那一栏。
